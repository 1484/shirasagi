this.Openlayers_Map_Form=function(){function e(e,t){var r,o;(null==t&&(t={}),this.clonePointForm=i(this.clonePointForm,this),this.canvas=e,this.opts=t,default_zoom=this.opts.default_zoom||Openlayers_Map.defaultZoom,pointCount=this.opts.markers?this.opts.markers.length:0,set_center_position=this.opts.set_center_position,set_center_position)&&(set_center_position=set_center_position.split(",").map(Number),set_center_position=[set_center_position[1],set_center_position[0]],r=set_center_position[1],o=set_center_position[0],r&&!isNaN(r)||(set_center_position=null),o&&!isNaN(o)||(set_center_position=null),-90<=r&&r<=90&&-180<=o&&o<=180?set_center_position:set_center_position=null);set_zoom_level=this.opts.set_zoom_level,this.markerFeature=null,this.markerLayer=null,this.popup=null,this.maxPointForm=10,this.deleteMessage="\u30de\u30fc\u30ab\u30fc\u3092\u524a\u9664\u3057\u3066\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f",this.dataID=0,this.markerIcon="/assets/img/map-marker.png",this.clickIcon="/assets/img/map-marker-click.png",this.clickMarkerId=null,this.render()}var i=function(e,t){return function(){return e.apply(t,arguments)}};return e.prototype.getMapLoc=function(e){var t;return t=e.val().split(","),[parseFloat(t[0]),parseFloat(t[1])]},e.prototype.setMapLoc=function(e,t,r){t=Math.ceil(t*Math.pow(10,6))/Math.pow(10,6),r=Math.ceil(r*Math.pow(10,6))/Math.pow(10,6),e.val(t.toFixed(6)+","+r.toFixed(6))},e.prototype.render=function(){this.initMap(),this.renderMarkers(),this.initPopup(),this.resize(),this.renderEvents()},e.prototype.createLayers=function(e){var t,r,o,i,a,n,s,p;for(o=[],t=0,i=e.length;t<i;t++)s=(a=e[t]).source,p=a.url,n=a.projection,r=new ol.layer.Tile({source:new ol.source[s]({url:p,projection:n})}),o.push(r);return o},e.prototype.initMap=function(){var e,t;return e=this.opts.center||[138.252924,36.204824],set_center_position&&(e=set_center_position),(t=this.opts.layers)||(t=[{source:"XYZ",url:"https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",projection:"EPSG:3857"}]),this.maxPointForm=this.opts.max_point_form||10,this.map=new ol.Map({target:this.canvas,renderer:["canvas","dom"],layers:this.createLayers(t),controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),view:new ol.View({projection:"EPSG:3857",center:ol.proj.transform(e,"EPSG:4326","EPSG:3857"),minZoom:3,maxZoom:18,zoom:this.opts.zoom||10}),logo:!1})},e.prototype.initPopup=function(){var o,e;return $("body").append('<div id="marker-popup"><div class="closer"></div><div class="content"></div></div>'),this.popup=$("#marker-popup"),this.popup.hide(),this.popupOverlay=new ol.Overlay({element:this.popup.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),this.map.addOverlay(this.popupOverlay),this.map.on("pointermove",(o=this,function(e){var t,r;if(!e.dragging)return r=o.map.getEventPixel(e.originalEvent),t=o.map.hasFeatureAtPixel(r)?"pointer":"",o.map.getTarget().style.cursor=t;o.popup.hide()})),this.popup.find(".closer").on("click",(e=this,function(){return e.popupOverlay.setPosition(void 0),$(e).blur(),!1}))},e.prototype.renderMarkers=function(){return $(".mod-map dd.marker").each((o=this,function(e,t){var r;return $(t).attr("data-id",o.dataID),""!==$(t).find(".marker-loc").val()&&(r=o.getMapLoc($(t).find(".marker-loc")),o.setMarker(r,{id:parseInt(o.dataID)})),o.dataID+=1}));var o},e.prototype.showPopup=function(e,t){var r,o;if(0===(o=t.get("markerId"))||o){if(r="",$('dd[data-id = "'+o+'"]').each(function(){var e,t;if(e=$(this).find(".marker-name").val(),t=$(this).find(".marker-text").val(),e&&(r+="<p>"+e+"</p>"),t)return $.each(t.split(/[\r\n]+/),function(){return this.match(/^https?:\/\//)?r+='<p><a href="'+this+'">'+this+"</a></p>":r+="<p>"+this+"</p>"})}),r)return this.popup.find(".content").html(r),this.popup.attr({dataId:o}),this.popup.show(),this.popupOverlay.setPosition(e.coordinate)}else this.popup.hide()},e.prototype.setMarker=function(e,t){var r,o,i,a,n,s,p;return null==t&&(t={}),s=this.markerIcon,t.image&&(s=t.image),p=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:s})}),o=[e[1],e[0]],(r=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(o,"EPSG:4326","EPSG:3857")),markerId:null!=(i=t.id)?i:null,markerHtml:null!=(a=t.html)?a:null,category:null!=(n=t.category)?n:null})).setStyle(p),this.markerLayer?this.markerLayer.getSource().addFeature(r):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[r]})}),this.map.addLayer(this.markerLayer)),r},e.prototype.getMarker=function(t){var r;return r=null,this.markerLayer&&this.markerLayer.getSource().forEachFeature(function(e){if(e.get("markerId")===t)return r=e}),r},e.prototype.removeMarker=function(e){var t;return!!(t=this.getMarker(e))&&(this.markerLayer.getSource().removeFeature(t),t.get("markerId")===parseInt(this.popup.attr("dataId"))&&this.popup.hide(),!0)},e.prototype.renderEvents=function(){var o,e,r,i,t,a,n;return this.map.on("click",(o=this,function(e){var t,r;if(!(t=o.map.forEachFeatureAtPixel(e.pixel,function(e){return e}))){for(o.clickMarkerId&&(t=o.getMarker(o.clickMarkerId),o.markerLayer.getSource().removeFeature(t)),r=ol.proj.transform(e.coordinate,"EPSG:3857","EPSG:4326");r[0]<180;)r[0]+=360;for(;180<r[0];)r[0]-=360;return r.reverse(),o.clickMarkerId="click",o.setMarker(r,{image:o.clickIcon,id:o.clickMarkerId}),o.setMapLoc($(".mod-map .clicked"),r[0],r[1])}o.showPopup(e,t)})),this.map.getView().on("propertychange",function(e){if("resolution"===e.key){var t=this.getZoom();$('input[name="item[map_zoom_level]"]').val(t)}}),$(".mod-map .add-marker").on("click",(e=this,function(){return e.clonePointForm(),!1})),$(".mod-map .clear-marker").on("click",(r=this,function(e){var t;return t=e.target,r.clearPointForm($(t).closest("dd.marker")),!1})),$(".mod-map .set-center-position").on("click",(i=this,function(){var e=ol.proj.transform(i.map.getView().getCenter(),"EPSG:3857","EPSG:4326"),t=Math.floor(1e6*e[1])/1e6,r=Math.floor(1e6*e[0])/1e6;return $(".center-input").val(t+","+r),!1})),$(".mod-map .set-zoom-level").on("click",(t=this,function(){return $(".zoom-input").val(t.map.getView().getZoom()),!1})),$(".mod-map .set-marker").on("click",(a=this,function(e){var t;return t=e.target,a.createMarker($(t).closest("dd.marker")),!1})),$(".mod-map .marker-name").on("keypress",function(e){if(13===e.which)return!1}),$(".mod-map .marker-loc-input").on("keypress",function(e){if(13===e.which)return $(this).closest("dd.marker").find(".set-marker").trigger("click"),!1}),$(".mod-map .marker-loc-input").on("focus",(n=this,function(){var e;if(n.clickMarkerId)return e=n.getMarker(n.clickMarkerId),n.markerLayer.getSource().removeFeature(e),n.clickMarkerId=null,$(".mod-map .clicked").val("")})),$(".location-search").hide()},e.prototype.clonePointForm=function(){var e,t,r,o;$(".mod-map dd.marker").length<this.maxPointForm&&((e=$(".mod-map dd.marker:last").clone(!1).insertAfter($(".mod-map dd.marker:last"))).attr("data-id",this.dataID),this.dataID+=1,e.find("input,textarea").val(""),e.find(".marker-name").val(""),e.find(".clear-marker").on("click",(o=this,function(){return o.clearPointForm(e)})),e.find(".set-marker").on("click",(r=this,function(){return r.createMarker(e)})),e.find(".marker-name").on("keypress",function(e){if(13===e.which)return!1}),e.find(".marker-loc-input").on("keypress",function(e){if(13===e.which)return $(e.target).closest("dd.marker").find(".set-marker").trigger("click"),!1}),e.find(".marker-loc-input").on("focus",(t=this,function(){var e;if(t.clickMarkerId)return e=t.getMarker(t.clickMarkerId),t.markerLayer.getSource().removeFeature(e),t.clickMarkerId=null,$(".mod-map .clicked").val("")}))),$(".mod-map dd.marker").length===this.maxPointForm&&$(".mod-map dd .add-marker").parent().hide()},e.prototype.createMarker=function(e){var t,r;if(r=null,""!==$(".mod-map .clicked").val()?r=$(".mod-map .clicked").val():""!==e.find(".marker-loc-input").val()&&(Map_Form.validateLoc(e.find(".marker-loc-input"))?r=e.find(".marker-loc-input").val():alert("\u6b63\u3057\u3044\u5ea7\u6a19\u3092\u30ab\u30f3\u30de(,)\u533a\u5207\u308a\u3067\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u4f8b\uff0933.8957612,133.6806607")),r)return e.find(".marker-loc").val(r),e.find(".marker-loc-input").val(r),t=parseInt(e.attr("data-id")),this.removeMarker(t),this.setMarker(this.getMapLoc(e.find(".marker-loc")),{id:t})},e.prototype.clearPointForm=function(e){var t;""!==e.find(".marker-loc").val()?confirm(this.deleteMessage)&&(t=parseInt(e.attr("data-id")),this.removeMarker(t),e.find("input,textarea").val(""),1<$(".mod-map dd.marker").length&&e.remove()):(t=parseInt(e.attr("data-id")),this.removeMarker(t),e.find("input,textarea").val(""),1<$(".mod-map dd.marker").length&&e.remove()),$(".mod-map dd .add-marker").parent().show()},e.prototype.resize=function(){var e;return 1!=pointCount||set_center_position||set_zoom_level?1==pointCount&&!set_center_position&&set_zoom_level?(e=this.markerLayer.getSource().getExtent(),this.map.getView().fit(e,this.map.getSize()),void this.map.getView().setZoom(set_zoom_level)):2<=pointCount&&!set_center_position&&!set_zoom_level?(e=this.markerLayer.getSource().getExtent(),void this.map.getView().fit(e,this.map.getSize())):2<=pointCount&&!set_center_position&&set_zoom_level?(e=this.markerLayer.getSource().getExtent(),this.map.getView().fit(e,this.map.getSize()),void this.map.getView().setZoom(set_zoom_level)):void(set_zoom_level?this.map.getView().setZoom(set_zoom_level):set_zoom_level||this.map.getView().setZoom(default_zoom)):(e=this.markerLayer.getSource().getExtent(),this.map.getView().fit(e,this.map.getSize()),void this.map.getView().setZoom(default_zoom))},e}();