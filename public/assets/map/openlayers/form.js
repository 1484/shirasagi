this.Openlayers_Map_Form=function(){function r(r,t){null==t&&(t={}),this.clonePointForm=e(this.clonePointForm,this),this.canvas=r,this.opts=t,this.markerFeature=null,this.markerLayer=null,this.popup=null,this.maxPointForm=10,this.deleteMessage="\u30de\u30fc\u30ab\u30fc\u3092\u524a\u9664\u3057\u3066\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f",this.dataID=0,this.markerIcon="/assets/img/map-marker.png",this.clickIcon="/assets/img/map-marker-click.png",this.clickMarkerId=null,this.render()}var e=function(r,e){return function(){return r.apply(e,arguments)}};return r.prototype.getMapLoc=function(r){var e;return e=r.val().split(","),[parseFloat(e[0]),parseFloat(e[1])]},r.prototype.setMapLoc=function(r,e,t){e=Math.ceil(e*Math.pow(10,6))/Math.pow(10,6),t=Math.ceil(t*Math.pow(10,6))/Math.pow(10,6),r.val(e.toFixed(6)+","+t.toFixed(6))},r.prototype.render=function(){this.initMap(),this.renderMarkers(),this.initPopup(),this.resize(),this.renderEvents()},r.prototype.createLayers=function(r){var e,t,a,o,i,n,p,c;for(a=[],e=0,o=r.length;e<o;e++)p=(i=r[e]).source,c=i.url,n=i.projection,t=new ol.layer.Tile({source:new ol.source[p]({url:c,projection:n})}),a.push(t);return a},r.prototype.initMap=function(){var r,e;return r=this.opts.center||[138.252924,36.204824],(e=this.opts.layers)||(e=[{source:"XYZ",url:"http://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",projection:"EPSG:3857"}]),this.maxPointForm=this.opts.max_point_form||10,this.map=new ol.Map({target:this.canvas,renderer:["canvas","dom"],layers:this.createLayers(e),controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),view:new ol.View({projection:"EPSG:3857",center:ol.proj.transform(r,"EPSG:4326","EPSG:3857"),minZoom:3,maxZoom:18,zoom:this.opts.zoom||10}),logo:!1})},r.prototype.initPopup=function(){var r;return $("body").append('<div id="marker-popup"><div class="closer"></div><div class="content"></div></div>'),this.popup=$("#marker-popup"),this.popup.hide(),this.popupOverlay=new ol.Overlay({element:this.popup.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),this.map.addOverlay(this.popupOverlay),this.map.on("pointermove",(r=this,function(e){var t,a;if(!e.dragging)return a=r.map.getEventPixel(e.originalEvent),t=r.map.hasFeatureAtPixel(a)?"pointer":"",r.map.getTarget().style.cursor=t;r.popup.hide()})),this.popup.find(".closer").on("click",function(r){return function(){return r.popupOverlay.setPosition(void 0),$(r).blur(),!1}}(this))},r.prototype.renderMarkers=function(){return $(".mod-map dd.marker").each((r=this,function(e,t){var a;return $(t).attr("data-id",r.dataID),""!==$(t).find(".marker-loc").val()&&(a=r.getMapLoc($(t).find(".marker-loc")),r.setMarker(a,{id:parseInt(r.dataID)})),r.dataID+=1}));var r},r.prototype.showPopup=function(r,e){var t,a;if(0===(a=e.get("markerId"))||a){if(t="",$('dd[data-id = "'+a+'"]').each(function(){var r,e;if(r=$(this).find(".marker-name").val(),e=$(this).find(".marker-text").val(),r&&(t+="<p>"+r+"</p>"),e)return $.each(e.split(/[\r\n]+/),function(){return this.match(/^https?:\/\//)?t+='<p><a href="'+this+'">'+this+"</a></p>":t+="<p>"+this+"</p>"})}),t)return this.popup.find(".content").html(t),this.popup.attr({dataId:a}),this.popup.show(),this.popupOverlay.setPosition(r.coordinate)}else this.popup.hide()},r.prototype.setMarker=function(r,e){var t,a,o,i,n,p,c;return null==e&&(e={}),p=this.markerIcon,e.image&&(p=e.image),c=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:p})}),a=[r[1],r[0]],(t=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(a,"EPSG:4326","EPSG:3857")),markerId:null!=(o=e.id)?o:null,markerHtml:null!=(i=e.html)?i:null,category:null!=(n=e.category)?n:null})).setStyle(c),this.markerLayer?this.markerLayer.getSource().addFeature(t):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[t]})}),this.map.addLayer(this.markerLayer)),t},r.prototype.getMarker=function(r){var e;return e=null,this.markerLayer?(this.markerLayer.getSource().forEachFeature(function(t){if(t.get("markerId")===r)return e=t}),e):e},r.prototype.removeMarker=function(r){var e;return!!(e=this.getMarker(r))&&(this.markerLayer.getSource().removeFeature(e),e.get("markerId")===parseInt(this.popup.attr("dataId"))&&this.popup.hide(),!0)},r.prototype.renderEvents=function(){var r;return this.map.on("click",(r=this,function(e){var t,a;if(!(t=r.map.forEachFeatureAtPixel(e.pixel,function(r){return r}))){for(r.clickMarkerId&&(t=r.getMarker(r.clickMarkerId),r.markerLayer.getSource().removeFeature(t)),a=ol.proj.transform(e.coordinate,"EPSG:3857","EPSG:4326");a[0]<180;)a[0]+=360;for(;a[0]>180;)a[0]-=360;return a.reverse(),r.clickMarkerId="click",r.setMarker(a,{image:r.clickIcon,id:r.clickMarkerId}),r.setMapLoc($(".mod-map .clicked"),a[0],a[1])}r.showPopup(e,t)})),this.map.getView().on("propertychange",function(r){if("resolution"===r.key){var e=this.getZoom();$('input[name="item[map_zoom_level]"]').val(e)}}),$(".mod-map .add-marker").on("click",function(r){return function(){return r.clonePointForm(),!1}}(this)),$(".mod-map .clear-marker").on("click",function(r){return function(e){var t;return t=e.target,r.clearPointForm($(t).closest("dd.marker")),!1}}(this)),$(".mod-map .set-marker").on("click",function(r){return function(e){var t;return t=e.target,r.createMarker($(t).closest("dd.marker")),!1}}(this)),$(".mod-map .marker-name").on("keypress",function(r){if(13===r.which)return!1}),$(".mod-map .marker-loc-input").on("keypress",function(r){if(13===r.which)return $(this).closest("dd.marker").find(".set-marker").trigger("click"),!1}),$(".mod-map .marker-loc-input").on("focus",function(r){return function(){var e;if(r.clickMarkerId)return e=r.getMarker(r.clickMarkerId),r.markerLayer.getSource().removeFeature(e),r.clickMarkerId=null,$(".mod-map .clicked").val("")}}(this)),$(".location-search").hide()},r.prototype.clonePointForm=function(){var r,e;$(".mod-map dd.marker").length<this.maxPointForm&&((r=$(".mod-map dd.marker:last").clone(!1).insertAfter($(".mod-map dd.marker:last"))).attr("data-id",this.dataID),this.dataID+=1,r.find("input,textarea").val(""),r.find(".marker-name").val(""),r.find(".clear-marker").on("click",(e=this,function(){return e.clearPointForm(r)})),r.find(".set-marker").on("click",function(e){return function(){return e.createMarker(r)}}(this)),r.find(".marker-name").on("keypress",function(r){if(13===r.which)return!1}),r.find(".marker-loc-input").on("keypress",function(r){if(13===r.which)return $(r.target).closest("dd.marker").find(".set-marker").trigger("click"),!1}),r.find(".marker-loc-input").on("focus",function(r){return function(){var e;if(r.clickMarkerId)return e=r.getMarker(r.clickMarkerId),r.markerLayer.getSource().removeFeature(e),r.clickMarkerId=null,$(".mod-map .clicked").val("")}}(this))),$(".mod-map dd.marker").length===this.maxPointForm&&$(".mod-map dd .add-marker").parent().hide()},r.prototype.createMarker=function(r){var e,t;if(t=null,""!==$(".mod-map .clicked").val()?t=$(".mod-map .clicked").val():""!==r.find(".marker-loc-input").val()&&(Map_Form.validateLoc(r.find(".marker-loc-input"))?t=r.find(".marker-loc-input").val():alert("\u6b63\u3057\u3044\u5ea7\u6a19\u3092\u30ab\u30f3\u30de(,)\u533a\u5207\u308a\u3067\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044\u3002\n\u4f8b\uff0933.8957612,133.6806607")),t)return r.find(".marker-loc").val(t),r.find(".marker-loc-input").val(t),e=parseInt(r.attr("data-id")),this.removeMarker(e),this.setMarker(this.getMapLoc(r.find(".marker-loc")),{id:e})},r.prototype.clearPointForm=function(r){var e;""!==r.find(".marker-loc").val()?confirm(this.deleteMessage)&&(e=parseInt(r.attr("data-id")),this.removeMarker(e),r.find("input,textarea").val(""),$(".mod-map dd.marker").length>1&&r.remove()):(e=parseInt(r.attr("data-id")),this.removeMarker(e),r.find("input,textarea").val(""),$(".mod-map dd.marker").length>1&&r.remove()),$(".mod-map dd .add-marker").parent().show()},r.prototype.resize=function(){if(this.markerLayer){var r=this.markerLayer.getSource().getExtent();this.map.getView().fit(r,this.map.getSize()),this.map.getView().getZoom()>this.opts.zoom&&this.map.getView().setZoom(this.opts.zoom)}},r}();