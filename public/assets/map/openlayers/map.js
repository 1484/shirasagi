this.Openlayers_Map=function(){function i(e,t){var o,r;(null==t&&(t={}),this.canvas=e,this.opts=t,default_zoom=this.opts.default_zoom||i.defaultZoom,pointCount=this.opts.markers?this.opts.markers.length:0,set_center_position=this.opts.set_center_position,set_center_position)&&(set_center_position=set_center_position.split(",").map(Number),set_center_position=[set_center_position[1],set_center_position[0]],o=set_center_position[1],r=set_center_position[0],o&&!isNaN(o)||(set_center_position=null),r&&!isNaN(r)||(set_center_position=null),-90<=o&&o<=90&&-180<=r&&r<=180?set_center_position:set_center_position=null);set_zoom_level=this.opts.set_zoom_level,this.opts.zoom||(this.opts.zoom=i.defaultZoom),this.markerFeature=null,this.markerLayer=null,this.popup=null,this.markerIcon="/assets/img/map-marker.png",this.render()}return i.defaultZoom=10,i.prototype.render=function(){return this.initMap(),this.initPopup(),this.opts.markers&&this.renderMarkers(this.opts.markers),this.resize(),this.renderEvents()},i.prototype.createLayers=function(e){var t,o,r,i,n,s,a,p;for(r=[],t=0,i=e.length;t<i;t++)a=(n=e[t]).source,p=n.url,s=n.projection,o=new ol.layer.Tile({source:new ol.source[a]({url:p,projection:s})}),r.push(o);return r},i.prototype.initMap=function(){var e,t;return e=this.opts.center||[138.252924,36.204824],set_center_position&&(e=set_center_position),(t=this.opts.layers)||(t=[{source:"XYZ",url:"https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",projection:"EPSG:3857"}]),this.map=new ol.Map({target:this.canvas,renderer:["canvas","dom"],layers:this.createLayers(t),controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),view:new ol.View({projection:"EPSG:3857",center:ol.proj.transform(e,"EPSG:4326","EPSG:3857"),maxZoom:18,zoom:this.opts.zoom}),logo:!0})},i.prototype.initPopup=function(){var r,e;return $("body").append('<div id="marker-popup"><div class="closer"></div><div class="content"></div></div>'),this.popup=$("#marker-popup"),this.popup.hide(),this.popupOverlay=new ol.Overlay({element:this.popup.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),this.map.addOverlay(this.popupOverlay),this.map.on("pointermove",(r=this,function(e){var t,o;if(!e.dragging)return o=r.map.getEventPixel(e.originalEvent),t=r.map.hasFeatureAtPixel(o)?"pointer":"",r.map.getTarget().style.cursor=t;r.popup.hide()})),this.popup.find(".closer").on("click",(e=this,function(){return e.popupOverlay.setPosition(void 0),$(e).blur(),!1}))},i.prototype.showPopup=function(e,t){var o;if(o=e.get("markerHtml"))return this.popup.find(".content").html(o),this.popup.show(),this.popupOverlay.setPosition(t);this.popup.hide()},i.prototype.renderEvents=function(){return this.map.on("click",(o=this,function(e){var t;(t=o.map.forEachFeatureAtPixel(e.pixel,function(e){return e}))&&o.showPopup(t,e.coordinate)}));var o},i.prototype.createMarkerStyle=function(e){return new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:e})})},i.prototype.setMarker=function(e,t){var o,r,i,n,s,a,p;return null==t&&(t={}),r=this.markerIcon,t.image&&(r=t.image),p=this.createMarkerStyle(r),i=[e[1],e[0]],(o=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(i,"EPSG:4326","EPSG:3857")),markerId:null!=(n=t.id)?n:null,markerHtml:null!=(s=t.html)?s:null,category:null!=(a=t.category)?a:null,iconSrc:r})).setStyle(p),this.markerLayer?this.markerLayer.getSource().addFeature(o):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[o]})}),this.map.addLayer(this.markerLayer)),o},i.prototype.getMarker=function(t){var o;return o=null,this.markerLayer&&this.markerLayer.getSource().forEachFeature(function(e){if(e.get("markerId")===t)return o=e}),o},i.prototype.getMarkers=function(){return this.markerLayer.getSource().getFeatures()},i.prototype.removeMarkers=function(){var t;this.popup&&this.popup.hide(),this.markerLayer&&(t=this.markerLayer.getSource()).forEachFeature(function(e){t.removeFeature(e)})},i.prototype.setCenter=function(e){return this.map.getView().setCenter(ol.proj.transform(e,"EPSG:4326","EPSG:3857"))},i.prototype.setZoom=function(e){return this.map.getView().setZoom(e)},i.prototype.renderMarkers=function(e){var t,o,r,i,n,s,a,p,l,u,m,c,h;for(m=[],r=0;r<e.length;r++)o="/assets/img/map-marker.png",(i=e[r]).image&&(o=i.image),c=this.createMarkerStyle(o),n="",s=i.name,h=i.text,s&&(n+="<p>"+s+"</p>"),h&&$.each(h.split(/[\r\n]+/),function(){return this.match(/^https?:\/\//)?n+='<p><a href="'+this+'">'+this+"</a></p>":n+="<p>"+this+"</p>"}),a=[i.loc[1],i.loc[0]],(t=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(a,"EPSG:4326","EPSG:3857")),markerId:null!=(p=i.id)?p:r,markerHtml:null!=(l=i.html)?l:n,category:null!=(u=i.category)?u:null,iconSrc:o})).setStyle(c),this.markerLayer?m.push(this.markerLayer.getSource().addFeature(t)):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[t]})}),m.push(this.map.addLayer(this.markerLayer)));return m},i.prototype.resize=function(){var e;if(this.markerLayer)return 1!=pointCount||set_center_position||set_zoom_level?1==pointCount&&!set_center_position&&set_zoom_level?(e=this.markerLayer.getSource().getExtent(),this.map.getView().fit(e,this.map.getSize()),void this.map.getView().setZoom(set_zoom_level)):2<=pointCount&&!set_center_position&&!set_zoom_level?(e=this.markerLayer.getSource().getExtent(),void this.map.getView().fit(e,this.map.getSize())):2<=pointCount&&!set_center_position&&set_zoom_level?(e=this.markerLayer.getSource().getExtent(),this.map.getView().fit(e,this.map.getSize()),void this.map.getView().setZoom(set_zoom_level)):void(set_zoom_level?this.map.getView().setZoom(set_zoom_level):set_zoom_level||this.map.getView().setZoom(default_zoom)):(e=this.markerLayer.getSource().getExtent(),this.map.getView().fit(e,this.map.getSize()),void this.map.getView().setZoom(default_zoom))},i.prototype.loadLayer=function(n,e){var s=this,a=n,p=e,l=new ol.source.Vector({format:new p,loader:function(t,e,o){o.getCode();var r=new XMLHttpRequest,i=function(){console.log("loadLayer error:"+n)};r.open("GET",a),r.onerror=i,r.onloadstart=function(){$(s.canvas).hide()},r.onload=function(){if(200==r.status){var e=(new p).readFeatures(r.responseText,{featureProjection:o});l.addFeatures(e),t=u.getSource().getExtent(),$(s.canvas).show(),s.map.getView().fit(t,s.map.getSize()),s.map.getView().getZoom()>s.opts.zoom&&s.map.getView().setZoom(s.opts.zoom)}else i()},r.send()}}),u=new ol.layer.Vector({map:this.map,source:l})},i}();