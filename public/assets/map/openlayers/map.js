this.Openlayers_Map=function(){function e(t,r){null==r&&(r={}),this.canvas=t,this.opts=r,this.opts.zoom||(this.opts.zoom=e.defaultZoom),this.markerFeature=null,this.markerLayer=null,this.popup=null,this.markerIcon="/assets/img/map-marker.png",this.render()}return e.defaultZoom=10,e.prototype.render=function(){return this.initMap(),this.initPopup(),this.opts.markers&&this.renderMarkers(this.opts.markers),this.resize(),this.renderEvents()},e.prototype.createLayers=function(e){var t,r,o,a,n,i,s,p;for(o=[],t=0,a=e.length;t<a;t++)s=(n=e[t]).source,p=n.url,i=n.projection,r=new ol.layer.Tile({source:new ol.source[s]({url:p,projection:i})}),o.push(r);return o},e.prototype.initMap=function(){var e,t;return e=this.opts.center||[138.252924,36.204824],(t=this.opts.layers)||(t=[{source:"XYZ",url:"http://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",projection:"EPSG:3857"}]),this.map=new ol.Map({target:this.canvas,renderer:["canvas","dom"],layers:this.createLayers(t),controls:ol.control.defaults({attributionOptions:{collapsible:!1}}),view:new ol.View({projection:"EPSG:3857",center:ol.proj.transform(e,"EPSG:4326","EPSG:3857"),maxZoom:18,zoom:this.opts.zoom}),logo:!0})},e.prototype.initPopup=function(){var e;return $("body").append('<div id="marker-popup"><div class="closer"></div><div class="content"></div></div>'),this.popup=$("#marker-popup"),this.popup.hide(),this.popupOverlay=new ol.Overlay({element:this.popup.get(0),autoPan:!0,autoPanAnimation:{duration:250}}),this.map.addOverlay(this.popupOverlay),this.map.on("pointermove",(e=this,function(t){var r,o;if(!t.dragging)return o=e.map.getEventPixel(t.originalEvent),r=e.map.hasFeatureAtPixel(o)?"pointer":"",e.map.getTarget().style.cursor=r;e.popup.hide()})),this.popup.find(".closer").on("click",function(e){return function(){return e.popupOverlay.setPosition(void 0),$(e).blur(),!1}}(this))},e.prototype.showPopup=function(e,t){var r;if(r=e.get("markerHtml"))return this.popup.find(".content").html(r),this.popup.show(),this.popupOverlay.setPosition(t);this.popup.hide()},e.prototype.renderEvents=function(){return this.map.on("click",(e=this,function(t){var r;(r=e.map.forEachFeatureAtPixel(t.pixel,function(e){return e}))&&e.showPopup(r,t.coordinate)}));var e},e.prototype.createMarkerStyle=function(e){return new ol.style.Style({image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",src:e})})},e.prototype.setMarker=function(e,t){var r,o,a,n,i,s,p;return null==t&&(t={}),o=this.markerIcon,t.image&&(o=t.image),p=this.createMarkerStyle(o),a=[t.loc[1],t.loc[0]],(r=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(a,"EPSG:4326","EPSG:3857")),markerId:null!=(n=t.id)?n:null,markerHtml:null!=(i=t.html)?i:null,category:null!=(s=t.category)?s:null,iconSrc:o})).setStyle(p),this.markerLayer?this.markerLayer.getSource().addFeature(r):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[r]})}),this.map.addLayer(this.markerLayer)),r},e.prototype.getMarker=function(e){var t;return t=null,this.markerLayer?(this.markerLayer.getSource().forEachFeature(function(r){if(r.get("markerId")===e)return t=r}),t):t},e.prototype.getMarkers=function(){return this.markerLayer.getSource().getFeatures()},e.prototype.setCenter=function(e){return this.map.getView().setCenter(ol.proj.transform(e,"EPSG:4326","EPSG:3857"))},e.prototype.setZoom=function(e){return this.map.getView().setZoom(e)},e.prototype.renderMarkers=function(e){var t,r,o,a,n,i,s,p,u,l,c,h,m;for(o in c=[],e)r="/assets/img/map-marker.png",(a=e[o]).image&&(r=a.image),h=this.createMarkerStyle(r),n="",i=a.name,m=a.text,i&&(n+="<p>"+i+"</p>"),m&&$.each(m.split(/[\r\n]+/),function(){return this.match(/^https?:\/\//)?n+='<p><a href="'+this+'">'+this+"</a></p>":n+="<p>"+this+"</p>"}),s=[a.loc[1],a.loc[0]],(t=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(s,"EPSG:4326","EPSG:3857")),markerId:null!=(p=a.id)?p:o,markerHtml:null!=(u=a.html)?u:n,category:null!=(l=a.category)?l:null,iconSrc:r})).setStyle(h),this.markerLayer?c.push(this.markerLayer.getSource().addFeature(t)):(this.markerLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[t]})}),c.push(this.map.addLayer(this.markerLayer)));return c},e.prototype.resize=function(){var e;this.markerLayer&&(e=this.markerLayer.getSource().getExtent(),this.map.getView().fit(e,this.map.getSize()),this.map.getView().getZoom()>this.opts.zoom&&this.map.getView().setZoom(this.opts.zoom))},e}();