<%= javascript_include_tag "/assets/js/jquery.colorbox.js" %>
<%= stylesheet_link_tag "/assets/css/colorbox/colorbox.css" %>

<%= javascript_include_tag "http://maps.googleapis.com/maps/api/js?v=3&sensor=false" %>
<%= coffee do %>

attachMessage = (id) ->
  google.maps.event.addListener markers[id]["marker"], 'click', (event) ->
    if(window.opened)
      window.opened.close()
    markers[id]["window"].open(markers[id]["marker"].getMap(), markers[id]["marker"])
    window.opened = markers[id]["window"]
    return
  return

window.initmap = ->
  #googleMap api v3
  mapOptions = {
    center: new google.maps.LatLng(35.392915, 139.442888),
    zoom: 5,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    panControl: false,
    zoomControl: true,
    zoomControlOptions: {
      style: google.maps.ZoomControlStyle.LARGE
    },
    mapTypeControl: true,
    scaleControl: true,
    scrollwheel: true,
    streetViewControl: true,
    overviewMapControl: true,
    overviewMapControlOptions: {
        opened: true
    }
  };

  window.map = new google.maps.Map(document.getElementById("map-canvas"),  mapOptions)
  window.markers = <%= raw @markers.to_json %>
  window.opened = null
  window.markerBounds = new google.maps.LatLngBounds()

  $.each markers, (id, value) ->
    if markers[id]["pointer_image"]
      markers[id]["marker"] = new google.maps.Marker(
        position: new google.maps.LatLng(value["loc"][0],value["loc"][1]),
        icon: markers[id]["pointer_image"],
        map: window.map
      )
    else
      markers[id]["marker"] = new google.maps.Marker(
        position: new google.maps.LatLng(value["loc"][0],value["loc"][1]),
        map: window.map
      )

    markerBounds.extend(new google.maps.LatLng(value["loc"][0],value["loc"][1]))
    markers[id]["window"] = new google.maps.InfoWindow(
      content: markers[id]["info"]
    )
    attachMessage(id)
    return

  unless $.isEmptyObject(markers)
    zoomChangeBoundsListener = google.maps.event.addListener map, 'bounds_changed', ( event ) ->
      if this.getZoom() > 13 && this.initialZoom == true
        this.setZoom(13)
        this.initialZoom = false
      google.maps.event.removeListener(zoomChangeBoundsListener)

    map.initialZoom = true
    map.fitBounds(markerBounds)

  return

$(window).on "load", ->
  window.initmap()

$ ->
  $(".filters a").on "click", ->
    if $(this).hasClass("clicked")
       $(this).removeClass("clicked")
    else
      $(this).addClass("clicked")

    dataIDs = []
    $(".filters a.clicked").each ->
      dataIDs.push parseInt($(this).attr("data-id"))

    $.each markers, (id, value) ->
      visible = false
      $.each dataIDs, ->
        if $.inArray(parseInt(this), markers[id]["category"]) >= 0
          visible = true
          return false
      if visible
        markers[id]["marker"].setVisible(true)
      else
        markers[id]["marker"].setVisible(false)
        markers[id]["window"].close()

    return false;

  $(".ajax-box").on "click", ->
    $.colorbox({ html: "<%=j render(partial: "modal", locals: { search_path: "./map.html" }) %>"})
    return false

<% end %>

<%= render partial: "navi", locals: { current: "map" } %>

<div id="map-canvas"></div>

<% categories = @categories.present? ? @categories : @cur_node.st_categories %>
<% if categories.present? %>
<nav class="filters">
  <ul>
    <% categories.each do |cate| %>
      <li class="<%= cate.basename %>">
        <%= link_to cate.name, "#", class: "clicked", "data-id" => cate.id %>
      </li>
    <% end %>
  </ul>
</nav>
<% end %>
